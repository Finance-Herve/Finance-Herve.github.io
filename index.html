<!DOCTYPE html><html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Suivi Financier</title>
  <style>
    /* Styles CSS bien structur√©s ici (inchang√©s car fonctionnels) */
  </style>
</head>
<body>
  <!-- Gmail Icone + Solde -->
  <img id="userGmailIcon" src="https://ssl.gstatic.com/ui/v1/icons/mail/rfr/gmail.ico" width="32" height="32" title="Afficher/masquer menu" />
  <div id="userMenu"></div>
  <div id="soldeBox">Solde : <span id="solde">0.00</span> FCFA</div>  <!-- Connexion -->  <form id="loginForm">
    <h2>Connexion</h2>
    <input type="email" id="loginEmail" placeholder="Email" required />
    <input type="password" id="loginPassword" placeholder="Mot de passe" required />
    <button type="submit">Se connecter</button>
  </form>  <!-- Inscription -->  <form id="registerForm">
    <h2>Inscription</h2>
    <input type="email" id="registerEmail" placeholder="Email" required />
    <input type="password" id="registerPassword" placeholder="Mot de passe" required minlength="6" />
    <button type="submit">S'inscrire</button>
  </form>  <!-- Section principale des finances -->  <section id="financeSection" style="display:none;">
    <h2>Ajouter une transaction</h2>
    <form id="financeForm">
      <label for="date">Date</label>
      <input type="date" id="date" placeholder="Date" required />
      <label for="type">Type</label>
      <select id="type" required>
        <option value="b√©n√©fice">B√©n√©fice</option>
        <option value="dette">Dette</option>
      </select>
      <label for="montant">Montant</label>
      <input type="number" id="montant" placeholder="Montant (FCFA)" step="0.01" required />
      <label for="description">Description</label>
      <input type="text" id="description" placeholder="Description" />
      <button type="submit">Ajouter</button>
    </form><div id="totaux">
  <p>Total b√©n√©fices : <span id="totalBenefices">0.00</span> FCFA</p>
  <p>Total dettes : <span id="totalDettes">0.00</span> FCFA</p>
</div>

<table id="tableau">
  <thead>
    <tr>
      <th>Date</th>
      <th>Type</th>
      <th>Montant (FCFA)</th>
      <th>Description</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

  </section>  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, addDoc, deleteDoc, doc, updateDoc, onSnapshot, query, where } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "VOTRE_API_KEY",
      authDomain: "VOTRE_DOMAINE",
      projectId: "VOTRE_ID_PROJECT",
      storageBucket: "VOTRE_BUCKET",
      messagingSenderId: "VOTRE_MESSAGING_ID",
      appId: "VOTRE_APP_ID"
    };

    const ADMIN_UID = "lrPodNjAlPRM1ZTpbHxkQBvvjG62";

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const financeRef = collection(db, "transactions");

    const userGmailIcon = document.getElementById("userGmailIcon");
    const userMenu = document.getElementById("userMenu");

    let loginForm = document.getElementById("loginForm");
    let registerForm = document.getElementById("registerForm");
    let financeSection = document.getElementById("financeSection");
    let tableauBody = document.querySelector("#tableau tbody");
    let totalBenefices = document.getElementById("totalBenefices");
    let totalDettes = document.getElementById("totalDettes");
    let solde = document.getElementById("solde");
    let financeForm = document.getElementById("financeForm");

    userGmailIcon.addEventListener("click", () => {
      if (auth.currentUser) {
        userMenu.innerHTML = `
          <div><strong>${auth.currentUser.email}</strong></div>
          <button onclick="firebaseSignOut()">D√©connexion</button>
        `;
        userMenu.style.display = userMenu.style.display === "block" ? "none" : "block";
      }
    });

    window.firebaseSignOut = () => {
      signOut(auth);
      userMenu.style.display = "none";
    };

    loginForm.onsubmit = async (e) => {
      e.preventDefault();
      try {
        await signInWithEmailAndPassword(auth, loginEmail.value, loginPassword.value);
        loginForm.reset();
      } catch (e) {
        alert("Erreur connexion : " + e.message);
      }
    };

    registerForm.onsubmit = async (e) => {
      e.preventDefault();
      try {
        await createUserWithEmailAndPassword(auth, registerEmail.value, registerPassword.value);
        alert("Inscription r√©ussie !");
        registerForm.reset();
      } catch (e) {
        alert("Erreur inscription : " + e.message);
      }
    };

    onAuthStateChanged(auth, (user) => {
      if (user) {
        loginForm.style.display = "none";
        registerForm.style.display = "none";
        financeSection.style.display = "block";

        const userQuery = (user.uid === ADMIN_UID)
          ? query(financeRef)
          : query(financeRef, where("uid", "==", user.uid));
        setupFinance(userQuery, user.uid);
      } else {
        loginForm.style.display = "block";
        registerForm.style.display = "block";
        financeSection.style.display = "none";
        tableauBody.innerHTML = "";
        solde.textContent = "0.00";
      }
    });

    function setupFinance(q, uid) {
      let currentEditId = null;

      financeForm.onsubmit = async (e) => {
        e.preventDefault();
        const date = document.getElementById("date").value;
        const type = document.getElementById("type").value;
        const montant = parseFloat(document.getElementById("montant").value);
        const description = document.getElementById("description").value;
        if (!date || isNaN(montant)) return alert("Date et montant valides requis");

        if (currentEditId) {
          await updateDoc(doc(db, "transactions", currentEditId), { date, type, montant, description });
          currentEditId = null;
          financeForm.querySelector("button").textContent = "Ajouter";
        } else {
          await addDoc(financeRef, { date, type, montant, description, uid });
        }
        financeForm.reset();
      };

      onSnapshot(q, (snapshot) => {
        tableauBody.innerHTML = "";
        let totalB = 0;
        let totalD = 0;

        snapshot.forEach(docSnap => {
          const data = docSnap.data();
          const id = docSnap.id;
          const canEdit = uid === ADMIN_UID || uid === data.uid;
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${data.date}</td>
            <td>${data.type}</td>
            <td>${data.montant.toFixed(2)}</td>
            <td>${data.description}</td>
            <td>
              ${canEdit ? `
                <button class="btn-action" onclick="editTransaction('${id}', '${data.date}', '${data.type}', ${data.montant}, '${data.description.replace(/'/g, "\\'")}')">‚úèÔ∏è</button>
                <button class="btn-action" onclick="deleteTransaction('${id}')">üóëÔ∏è</button>
              ` : ''}
            </td>
          `;
          tableauBody.appendChild(row);

          if (data.type === "b√©n√©fice") totalB += data.montant;
          else totalD += data.montant;
        });

        totalBenefices.textContent = totalB.toFixed(2);
        totalDettes.textContent = totalD.toFixed(2);
        solde.textContent = (totalB - totalD).toFixed(2);
      });

      window.deleteTransaction = async (id) => {
        if (confirm("Supprimer cette ligne ?")) await deleteDoc(doc(db, "transactions", id));
      };

      window.editTransaction = (id, date, type, montant, description) => {
        document.getElementById("date").value = date;
        document.getElementById("type").value = type;
        document.getElementById("montant").value = montant;
        document.getElementById("description").value = description;
        currentEditId = id;
        financeForm.querySelector("button").textContent = "Modifier";
      };
    }
  </script></body>
</html>
