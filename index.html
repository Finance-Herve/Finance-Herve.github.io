<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Suivi Financier</title>
  <style>
    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      background: #f4f7fa;
      color: #333;
    }

    #userGmailIcon {
      position: fixed;
      top: 12px;
      right: 12px;
      cursor: pointer;
      z-index: 9999;
    }

    #userMenu {
      position: fixed;
      top: 50px;
      right: 12px;
      background: white;
      border: 1px solid #ccc;
      border-radius: 6px;
      padding: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      display: none;
      z-index: 9999;
    }

    #soldeBox {
      background: white;
      padding: 10px 20px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgb(11 61 145 / 0.15);
      font-size: 16px;
      font-weight: bold;
      color: #0b3d91;
      display: inline-block;
      margin-bottom: 20px;
    }

    h2 {
      color: #0b3d91;
      margin-top: 40px;
      margin-bottom: 15px;
    }

    form {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgb(11 61 145 / 0.15);
      margin-bottom: 30px;
      max-width: 400px;
    }

    label {
      font-weight: bold;
      display: block;
      margin-top: 10px;
      margin-bottom: 5px;
    }

    input, select, button {
      width: 100%;
      padding: 10px;
      font-size: 15px;
      border: 1px solid #bbb;
      border-radius: 6px;
      box-sizing: border-box;
    }

    input:focus, select:focus {
      border-color: #0b3d91;
      outline: none;
    }

    button {
      background: #0b3d91;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 600;
      margin-top: 15px;
    }

    button:hover {
      background: #083070;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      box-shadow: 0 2px 6px rgb(11 61 145 / 0.15);
      border-radius: 10px;
      overflow: hidden;
    }

    th, td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }

    th {
      background: #0b3d91;
      color: white;
    }

    tr:hover {
      background: #f1f6ff;
    }

    .btn-action {
      background: transparent;
      border: none;
      cursor: pointer;
      font-size: 18px;
      margin-right: 8px;
      color: #0b3d91;
    }

    .btn-action:hover {
      color: #083070;
    }

    #totaux {
      display: none;
    }
  </style>
</head>
<body>
  <!-- Gmail Logo + Solde -->
  <img id="userGmailIcon" src="https://ssl.gstatic.com/ui/v1/icons/mail/rfr/gmail.ico" width="32" height="32" title="Afficher/masquer menu" />
  <div id="userMenu"></div>
  <div id="soldeBox">Solde : <span id="solde">0.00</span> FCFA</div>

  <!-- Connexion -->
  <form id="loginForm">
    <h2>Connexion</h2>
    <input type="email" id="loginEmail" placeholder="Email" required />
    <input type="password" id="loginPassword" placeholder="Mot de passe" required />
    <button type="submit">Se connecter</button>
  </form>

  <!-- Inscription -->
  <form id="registerForm">
    <h2>Inscription</h2>
    <input type="email" id="registerEmail" placeholder="Email" required />
    <input type="password" id="registerPassword" placeholder="Mot de passe" required minlength="6" />
    <button type="submit">S'inscrire</button>
  </form>

  <!-- Section Finance -->
  <section id="financeSection" style="display:none;">
    <h2>Ajouter une transaction</h2>
    <form id="financeForm">
      <label for="date">Date</label>
      <input type="date" id="date" required />
      <label for="type">Type</label>
      <select id="type" required>
        <option value="b√©n√©fice">B√©n√©fice</option>
        <option value="dette">Dette</option>
      </select>
      <label for="montant">Montant</label>
      <input type="number" id="montant" placeholder="Montant (FCFA)" step="0.01" required />
      <label for="description">Description</label>
      <input type="text" id="description" placeholder="Description" />
      <button type="submit">Ajouter</button>
    </form>

    <div id="totaux">
      <p>Total b√©n√©fices : <span id="totalBenefices">0.00</span> FCFA</p>
      <p>Total dettes : <span id="totalDettes">0.00</span> FCFA</p>
    </div>

    <table id="tableau">
      <thead>
        <tr>
          <th>Date</th>
          <th>Type</th>
          <th>Montant (FCFA)</th>
          <th>Description</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getFirestore, collection, addDoc, deleteDoc, doc, updateDoc, onSnapshot, query, where
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import {
      getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBz1TCvYIs6LmX7K1OI6iYIylRQbWSoyV4",
      authDomain: "suivi-financier-5d4d8.firebaseapp.com",
      projectId: "suivi-financier-5d4d8",
      storageBucket: "suivi-financier-5d4d8.appspot.com",
      messagingSenderId: "1049367187239",
      appId: "1:1049367187239:web:975fcd8e60d43d6850e302"
    };

    const ADMIN_UID = "lrPodNjAlPRM1ZTpbHxkQBvvjG62";

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const financeRef = collection(db, "transactions");

    const userGmailIcon = document.getElementById("userGmailIcon");
    const userMenu = document.getElementById("userMenu");

    let loginForm = document.getElementById("loginForm");
    let registerForm = document.getElementById("registerForm");
    let financeSection = document.getElementById("financeSection");
    let tableauBody = document.querySelector("#tableau tbody");
    let totalBenefices = document.getElementById("totalBenefices");
    let totalDettes = document.getElementById("totalDettes");
    let solde = document.getElementById("solde");
    let financeForm = document.getElementById("financeForm");

    userGmailIcon.addEventListener("click", () => {
      if (auth.currentUser) {
        userMenu.innerHTML = `
          <div><strong>${auth.currentUser.email}</strong></div>
          <button onclick="firebaseSignOut()">D√©connexion</button>
        `;
        userMenu.style.display = userMenu.style.display === "block" ? "none" : "block";
      }
    });

    window.firebaseSignOut = () => {
      signOut(auth);
      userMenu.style.display = "none";
    };

    loginForm.onsubmit = async (e) => {
      e.preventDefault();
      try {
        await signInWithEmailAndPassword(auth, loginEmail.value, loginPassword.value);
        loginForm.reset();
      } catch (e) {
        alert("Erreur connexion : " + e.message);
      }
    };

    registerForm.onsubmit = async (e) => {
      e.preventDefault();
      try {
        await createUserWithEmailAndPassword(auth, registerEmail.value, registerPassword.value);
        alert("Inscription r√©ussie !");
        registerForm.reset();
      } catch (e) {
        alert("Erreur inscription : " + e.message);
      }
    };

    onAuthStateChanged(auth, (user) => {
      if (user) {
        loginForm.style.display = "none";
        registerForm.style.display = "none";
        financeSection.style.display = "block";

        const userQuery = (user.uid === ADMIN_UID)
          ? query(financeRef)
          : query(financeRef, where("uid", "==", user.uid));
        setupFinance(userQuery, user.uid);
      } else {
        loginForm.style.display = "block";
        registerForm.style.display = "block";
        financeSection.style.display = "none";
        tableauBody.innerHTML = "";
        solde.textContent = "0.00";
      }
    });

    function setupFinance(q, uid) {
      let currentEditId = null;

      financeForm.onsubmit = async (e) => {
        e.preventDefault();
        const date = document.getElementById("date").value;
        const type = document.getElementById("type").value;
        const montant = parseFloat(document.getElementById("montant").value);
        const description = document.getElementById("description").value;
        if (!date || isNaN(montant)) return alert("Date et montant valides requis");

        if (currentEditId) {
          await updateDoc(doc(db, "transactions", currentEditId), { date, type, montant, description });
          currentEditId = null;
          financeForm.querySelector("button").textContent = "Ajouter";
        } else {
          await addDoc(financeRef, { date, type, montant, description, uid });
        }
        financeForm.reset();
      };

      onSnapshot(q, (snapshot) => {
        tableauBody.innerHTML = "";
        let totalB = 0;
        let totalD = 0;

        snapshot.forEach(docSnap => {
          const data = docSnap.data();
          const id = docSnap.id;
          const canEdit = uid === ADMIN_UID || uid === data.uid;
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${data.date}</td>
            <td>${data.type}</td>
            <td>${data.montant.toFixed(2)}</td>
            <td>${data.description}</td>
            <td>
              ${canEdit ? `
                <button class="btn-action" onclick="editTransaction('${id}', '${data.date}', '${data.type}', ${data.montant}, '${data.description.replace(/'/g, "\\'")}')">‚úèÔ∏è</button>
                <button class="btn-action" onclick="deleteTransaction('${id}')">üóëÔ∏è</button>
              ` : ''}
            </td>
          `;
          tableauBody.appendChild(row);

          if (data.type === "b√©n√©fice") totalB += data.montant;
          else totalD += data.montant;
        });

        totalBenefices.textContent = totalB.toFixed(2);
        totalDettes.textContent = totalD.toFixed(2);
        solde.textContent = (totalB - totalD).toFixed(2);
      });

      window.deleteTransaction = async (id) => {
        if (confirm("Supprimer cette ligne ?")) await deleteDoc(doc(db, "transactions", id));
      };

      window.editTransaction = (id, date, type, montant, description) => {
        document.getElementById("date").value = date;
        document.getElementById("type").value = type;
        document.getElementById("montant").value = montant;
        document.getElementById("description").value = description;
        currentEditId = id;
        financeForm.querySelector("button").textContent = "Modifier";
      };
    }
  </script>
</body>
  </html>
