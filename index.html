<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Suivi Financier</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .solde {
      font-size: 1.5em;
      font-weight: bold;
    }
    .gmail-icon {
      cursor: pointer;
    }
    .user-info {
      margin-top: 10px;
    }
    form {
      margin-top: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #333;
      padding: 8px;
      text-align: left;
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>

<div class="header">
  <div class="solde" id="solde">Solde : 0 €</div>
  <div>
    <img src="https://ssl.gstatic.com/ui/v1/icons/mail/rfr/logo_gmail_lockup_default_1x_r2.png" alt="Gmail" width="80" class="gmail-icon" onclick="toggleUserInfo()">
    <div id="user-info" class="user-info hidden">
      <div id="user-email"></div>
      <button onclick="logout()">Déconnexion</button>
    </div>
  </div>
</div>

<form id="transaction-form">
  <input type="number" id="montant" placeholder="Montant" required>
  <select id="type">
    <option value="benefice">Bénéfice</option>
    <option value="dette">Dette</option>
  </select>
  <input type="text" id="description" placeholder="Description" required>
  <input type="date" id="date" placeholder="Date" required>
  <button type="submit">Ajouter</button>
</form>

<table>
  <thead>
    <tr>
      <th>Montant</th>
      <th>Type</th>
      <th>Description</th>
      <th>Date</th>
    </tr>
  </thead>
  <tbody id="transactions-body"></tbody>
</table>

<script>
  const firebaseConfig = {
    apiKey: "TA_CLE_API",
    authDomain: "TON_PROJET.firebaseapp.com",
    databaseURL: "https://TON_PROJET.firebaseio.com",
    projectId: "TON_PROJET",
    storageBucket: "TON_PROJET.appspot.com",
    messagingSenderId: "ID_ENVOI",
    appId: "APP_ID"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();
  const adminUID = "lrPodNjAlPRM1ZTpbHxkQBvvjG62";

  const soldeEl = document.getElementById('solde');
  const userInfo = document.getElementById('user-info');
  const userEmail = document.getElementById('user-email');
  const form = document.getElementById('transaction-form');
  const transactionsBody = document.getElementById('transactions-body');

  let currentUID = null;

  function toggleUserInfo() {
    userInfo.classList.toggle('hidden');
  }

  function logout() {
    auth.signOut().then(() => location.reload());
  }

  auth.onAuthStateChanged(user => {
    if (user) {
      currentUID = user.uid;
      userEmail.textContent = user.email;

      const userPath = (user.uid === adminUID) ? 'transactions' : `transactions/${user.uid}`;

      db.ref(userPath).on('value', snapshot => {
        let solde = 0;
        transactionsBody.innerHTML = "";
        snapshot.forEach(child => {
          const data = child.val();
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${data.montant} €</td>
            <td>${data.type}</td>
            <td>${data.description}</td>
            <td>${data.date}</td>
          `;
          transactionsBody.appendChild(tr);
          solde += (data.type === 'benefice') ? Number(data.montant) : -Number(data.montant);
        });
        soldeEl.textContent = `Solde : ${solde} €`;
      });
    } else {
      window.location.href = "login.html";
    }
  });

  form.addEventListener('submit', e => {
    e.preventDefault();
    const montant = document.getElementById('montant').value;
    const type = document.getElementById('type').value;
    const description = document.getElementById('description').value;
    const date = document.getElementById('date').value;

    const data = { montant, type, description, date };

    const path = `transactions/${currentUID}`;
    db.ref(path).push(data).then(() => form.reset());
  });
</script>

</body>
</html>
