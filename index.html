<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Suivi Financier</title>

<style>
body { font-family: Arial, sans-serif; margin: 20px; }
#soldeDisplay {
  position: fixed; top: 20px; left: 20px;
  background: #b7e4c7; padding: 10px;
  border-radius: 5px; font-weight: bold;
}
.auth, form, table { margin-top: 90px; max-width: 900px; }
input, select { padding: 8px; margin: 5px; }
button { padding: 6px 12px; cursor: pointer; }
.hidden { display: none; }
table { width: 100%; border-collapse: collapse; margin-top: 10px; }
th, td { border: 1px solid #ccc; padding: 6px; }
th { background: #d8f3dc; }
.actions { display: flex; gap: 5px; }
.month-header {
  background: #edf6f9;
  font-weight: bold;
  cursor: pointer;
}
.download-btn {
  float: right;
  background: #457b9d;
  color: white;
  border: none;
}
</style>
</head>

<body>

<div id="soldeDisplay">Solde : <span id="solde">0.00</span> F</div>

<div class="auth">
  <h3>Connexion</h3>
  <input id="email" type="email" placeholder="Email">
  <input id="password" type="password" placeholder="Mot de passe">
  <button id="loginBtn">Connexion</button>
</div>

<form id="financeForm" class="hidden">
  <h3>Ajouter une transaction</h3>
  <input type="date" id="date" required>
  <select id="type">
    <option value="bénéfice">Bénéfice</option>
    <option value="dette">Dette</option>
  </select>
  <input type="number" id="montant" placeholder="Montant">
  <input type="text" id="description" placeholder="Description">
  <button type="submit">Ajouter</button>
</form>

<table id="tableau" class="hidden">
<thead>
<tr>
  <th>Date</th>
  <th>Type</th>
  <th>Montant</th>
  <th>Description</th>
  <th>Actions</th>
</tr>
</thead>
<tbody></tbody>
</table>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-auth.js";
import { getFirestore, collection, addDoc, query, where, onSnapshot } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDOCmfhq0IImy7qs4o4ElLmbiS5IUuK00c",
  authDomain: "finances-a44b6.firebaseapp.com",
  projectId: "finances-a44b6"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth();
const db = getFirestore(app);

const soldeEl = document.getElementById("solde");
const body = document.querySelector("#tableau tbody");
const table = document.getElementById("tableau");
const form = document.getElementById("financeForm");

let currentUser = null;
let currentData = [];

function monthKey(d){ return d.slice(0,7); }
function monthLabel(k){
  const m=["Janvier","Février","Mars","Avril","Mai","Juin","Juillet","Août","Septembre","Octobre","Novembre","Décembre"];
  const [y,mo]=k.split("-");
  return `Mois de ${m[mo-1]} ${y}`;
}
function yearKey(d){ return d.slice(0,4); }

function solde(data){
  let b=0,d=0;
  data.forEach(i=> i.type==="bénéfice"?b+=i.montant:d+=i.montant);
  return (b-d).toFixed(2);
}

document.getElementById("loginBtn").onclick=()=>{
  signInWithEmailAndPassword(auth,email.value,password.value);
};

onAuthStateChanged(auth,user=>{
  if(!user) return;
  currentUser=user;
  document.querySelector(".auth").classList.add("hidden");
  form.classList.remove("hidden");
  table.classList.remove("hidden");

  const q=query(collection(db,"transactions"),where("uid","==",user.uid));
  onSnapshot(q,snap=>{
    const grouped={};
    currentData=[];
    snap.forEach(d=>{
      const i=d.data();
      currentData.push(i);
      const k=monthKey(i.date);
      if(!grouped[k]) grouped[k]=[];
      grouped[k].push(i);
    });

    body.innerHTML="";
    Object.keys(grouped).sort().reverse().forEach(k=>{
      const data=grouped[k];
      const s=solde(data);

      const header=document.createElement("tr");
      header.className="month-header";
      header.innerHTML=`
        <td colspan="5">
          ${monthLabel(k)} — Solde : ${s} F
          <button class="download-btn" onclick="downloadMonth('${k}')">⬇️ Mois</button>
          <button class="download-btn" onclick="downloadYear('${k.slice(0,4)}')">⬇️ Année</button>
        </td>`;
      body.appendChild(header);

      data.forEach(i=>{
        const r=document.createElement("tr");
        r.className="hidden m-"+k;
        r.innerHTML=`
          <td>${i.date}</td>
          <td>${i.type}</td>
          <td>${i.montant}</td>
          <td>${i.description||""}</td>
          <td>-</td>`;
        body.appendChild(r);
      });

      header.onclick=()=>{
        document.querySelectorAll(".m-"+k).forEach(r=>r.classList.toggle("hidden"));
      };
    });

    if(currentData.length) soldeEl.textContent=solde(currentData);
  });
});

form.onsubmit=e=>{
  e.preventDefault();
  addDoc(collection(db,"transactions"),{
    uid:currentUser.uid,
    date:date.value,
    type:type.value,
    montant:+montant.value,
    description:description.value
  });
  form.reset();
};

window.downloadMonth=(k)=>{
  const {jsPDF}=window.jspdf;
  const doc=new jsPDF();
  const d=currentData.filter(i=>monthKey(i.date)===k);
  doc.text(monthLabel(k),14,15);
  doc.autoTable({
    head:[["Date","Type","Montant","Description"]],
    body:d.map(i=>[i.date,i.type,i.montant,i.description||""])
  });
  doc.save("Mois_"+k+".pdf");
};

window.downloadYear=(y)=>{
  const {jsPDF}=window.jspdf;
  const doc=new jsPDF();
  const d=currentData.filter(i=>yearKey(i.date)===y);
  doc.text("Année "+y,14,15);
  doc.autoTable({
    head:[["Date","Type","Montant","Description"]],
    body:d.map(i=>[i.date,i.type,i.montant,i.description||""])
  });
  doc.save("Annee_"+y+".pdf");
};
</script>

</body>
</html>
